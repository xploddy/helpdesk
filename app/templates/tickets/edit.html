{% extends "base.html" %}

{% block title %}Editar Chamado #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-10">
        <a href="{{ url_for('tickets.view_ticket', id=ticket.id) }}"
            class="text-sm font-bold text-muted hover:text-[var(--text-main)] transition-colors">Cancelar</a>
        <h2 class="text-lg font-bold">Editar Chamado #{{ ticket.id }}</h2>
        <div class="w-10"></div> <!-- Spacer for balance -->
    </div>

    <!-- Info Info -->
    <div class="mb-8">
        <h3 class="text-2xl font-bold mb-2">Atualizar Informações</h3>
        <p class="text-sm text-muted">Você pode alterar o título, categoria, prioridade ou descrição do chamado.</p>
    </div>

    <form action="{{ url_for('tickets.edit_ticket', id=ticket.id) }}" method="POST" enctype="multipart/form-data"
        class="space-y-6">

        <!-- Requester Selection (Admins Only) -->
        {% if current_user.role == 'admin' %}
        <div>
            <label for="user_id"
                class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Solicitante
                (Usuário)</label>
            <div class="flex space-x-2">
                <div class="relative flex-grow">
                    <select id="user_id" name="user_id" required
                        class="stitch-input appearance-none block w-full px-4 py-3 rounded-xl border focus:border-primary transition-all outline-none">
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if user.id==ticket.user_id %}selected{% endif %}>
                            {{ user.fullname or user.username }} ({{ user.username }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                        <i class="fa-solid fa-user text-xs"></i>
                    </div>
                </div>
                <!-- Search Field -->
                <div class="relative w-1/3">
                    <input type="text" id="user-search" onkeyup="filterUsers()" placeholder="Buscar..."
                        class="stitch-input block w-full px-4 py-3 rounded-xl border focus:border-primary transition-all outline-none text-sm">
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                        <i class="fa-solid fa-search text-xs"></i>
                    </div>
                </div>
            </div>
            <p class="text-[10px] text-muted mt-1">Como administrador, você pode alterar o solicitante deste chamado.
            </p>
        </div>
        {% endif %}

        <!-- Subject -->
        <div>
            <label for="title"
                class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Assunto</label>
            <input type="text" name="title" id="title" value="{{ ticket.title }}" required
                class="stitch-input block w-full px-4 py-3 rounded-xl border focus:border-primary transition-all outline-none">
        </div>


        <!-- Category & Observer -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="category"
                    class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Categoria</label>
                <div class="relative">
                    <select id="category" name="category"
                        class="stitch-input appearance-none block w-full px-4 py-3 rounded-xl border focus:border-primary transition-all outline-none">
                        {% for cat in categories %}
                        <option value="{{ cat.name }}" {% if ticket.category==cat.name %}selected{% endif %}>{{ cat.name
                            }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Searchable Observers Section -->
            <script>
                window.editTicketData = {
                    search: '',
                    open: false,
                    allUsers: {{ users_json | tojson | safe }},
                selectedObservers: [
                    {% for obs in ticket.observers %}
                { id: { { obs.id } }, username: "{{ obs.username }}", fullname: "{{ obs.fullname or obs.username }}" } {% if not loop.last %}, {% endif %}
                {% endfor %}
                    ],
                    get filteredUsers() {
                    if (!this.search) return [];
                    const s = this.search.toLowerCase();
                    return this.allUsers.filter(u =>
                        ((u.fullname || '').toLowerCase().includes(s) ||
                            (u.username || '').toLowerCase().includes(s)) &&
                        !this.selectedObservers.find(sel => sel.id === u.id)
                    );
                },
                addObserver(user) {
                    if (!this.selectedObservers.find(sel => sel.id === user.id)) {
                        this.selectedObservers.push(user);
                    }
                    this.search = '';
                    this.open = false;
                },
                removeObserver(userId) {
                    this.selectedObservers = this.selectedObservers.filter(sel => sel.id !== userId);
                }
                };
            </script>
            <div x-data="window.editTicketData">
                <label class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Observadores
                    (Cópia)</label>

                <!-- Selected Observers Badges -->
                <div class="flex flex-wrap gap-2 mb-3">
                    <template x-for="obs in selectedObservers" :key="obs.id">
                        <div
                            class="inline-flex items-center px-3 py-1 rounded-full text-[11px] font-bold bg-primary/10 text-primary border border-primary/20 transition-all hover:bg-primary/20 group">
                            <i class="fa-solid fa-eye mr-2 opacity-50 text-[9px]"></i>
                            <span x-text="obs.fullname || obs.username"></span>
                            <button type="button" @click="removeObserver(obs.id)"
                                class="ml-2 text-primary/50 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                            <!-- Hidden input for form submission -->
                            <input type="hidden" name="observer_ids" :value="obs.id">
                        </div>
                    </template>
                    <template x-if="selectedObservers.length === 0">
                        <span class="text-[10px] text-slate-400 italic">Nenhum observador selecionado</span>
                    </template>
                </div>

                <!-- Search Input -->
                <div class="relative">
                    <div class="relative">
                        <input type="text" x-model="search" @focus="open = true" @input="open = true"
                            placeholder="Pesquisar usuários para colocar em cópia..." autocomplete="off"
                            class="stitch-input block w-full pl-10 pr-10 py-3 rounded-xl border focus:border-primary transition-all outline-none text-sm">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-xs text-muted"></i>
                        <button type="button" x-show="search.length > 0" @click="search = ''; open = false"
                            class="absolute right-4 top-1/2 -translate-y-1/2 text-muted hover:text-red-500">
                            <i class="fa-solid fa-circle-xmark text-xs"></i>
                        </button>
                    </div>

                    <!-- Dropdown Results -->
                    <div x-show="open && search.length > 0" @click.away="open = false"
                        class="absolute z-50 mt-2 w-full stitch-surface border rounded-2xl shadow-2xl max-h-60 overflow-y-auto p-2"
                        style="display: none;">
                        <template x-for="u in filteredUsers" :key="u.id">
                            <button type="button" @click="addObserver(u)"
                                class="w-full text-left px-4 py-3 hover:bg-primary hover:text-white rounded-xl transition-all group flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-bold text-main group-hover:text-white"
                                        x-text="u.fullname || u.username"></p>
                                    <p class="text-[10px] text-muted group-hover:text-white/70 tracking-tight"
                                        x-text="'@' + u.username"></p>
                                </div>
                                <i
                                    class="fa-solid fa-plus text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                            </button>
                        </template>
                        <div x-show="filteredUsers.length === 0" class="py-6 text-center">
                            <p class="text-xs text-muted">Nenhum usuário encontrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Priority (Segmented Control) -->
        <div>
            <label class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Prioridade</label>
            <div class="flex p-1 stitch-surface border rounded-xl space-x-1">
                <input type="hidden" name="priority" id="priority-input" value="{{ ticket.priority }}">
                <button type="button" onclick="setPriority('Baixa', this)"
                    class="priority-btn flex-1 py-2 text-xs font-bold rounded-lg transition-all {% if ticket.priority == 'Baixa' %}bg-primary text-white{% else %}text-muted hover:text-[var(--text-main)]{% endif %}">Baixa</button>
                <button type="button" onclick="setPriority('Media', this)"
                    class="priority-btn flex-1 py-2 text-xs font-bold rounded-lg transition-all {% if ticket.priority == 'Media' %}bg-primary text-white{% else %}text-muted hover:text-[var(--text-main)]{% endif %}">Média</button>
                <button type="button" onclick="setPriority('Alta', this)"
                    class="priority-btn flex-1 py-2 text-xs font-bold rounded-lg transition-all {% if ticket.priority == 'Alta' %}bg-primary text-white{% else %}text-muted hover:text-[var(--text-main)]{% endif %}">Alta</button>
                <button type="button" onclick="setPriority('Critica', this)"
                    class="priority-btn flex-1 py-2 text-xs font-bold rounded-lg transition-all {% if ticket.priority == 'Critica' %}bg-primary text-white{% else %}text-muted hover:text-[var(--text-main)]{% endif %}">Urgente</button>
            </div>
        </div>

        <!-- Description -->
        <div>
            <label for="description"
                class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Descrição</label>
            <textarea id="description" name="description" rows="5" required
                class="stitch-input block w-full px-4 py-3 rounded-xl border focus:border-primary transition-all outline-none resize-none">{{ ticket.description }}</textarea>
        </div>

        <!-- Add Attachments -->
        <div>
            <label class="block text-[10px] uppercase font-bold tracking-widest text-muted mb-2">Adicionar
                Anexos</label>
            <div id="paste-area"
                class="border-2 border-dashed border-[var(--border-color)] rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-all text-slate-500"
                onclick="document.getElementById('attachment').click()">
                <i class="fa-solid fa-paperclip text-2xl mb-3"></i>
                <p class="text-xs font-medium">Clique para selecionar ou arraste arquivos</p>
                <p class="text-[10px] mt-1 opacity-50">Qualquer tipo de arquivo • Múltiplos arquivos permitidos</p>
            </div>
            <input type="file" name="attachment" id="attachment" class="hidden" multiple>

            <!-- Preview List -->
            <div id="file-list" class="mt-4 space-y-2 hidden">
                <!-- JS will populate this -->
            </div>
        </div>

        <!-- Submit -->
        <button type="submit"
            class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-primary/20 flex items-center justify-center space-x-2">
            <span>Salvar Alterações</span>
            <i class="fa-solid fa-save text-xs"></i>
        </button>
    </form>
</div>

<script>
    function setPriority(val, btn) {
        document.getElementById('priority-input').value = val;
        document.querySelectorAll('.priority-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('text-muted');
        });
        btn.classList.remove('text-muted');
        btn.classList.add('bg-primary', 'text-white');
    }

    function filterUsers() {
        const input = document.getElementById('user-search');
        const filter = input.value.toLowerCase();
        const select = document.getElementById('user_id');
        const options = select.getElementsByTagName('option');
        let hasVisible = false;

        for (let i = 0; i < options.length; i++) {
            const txtValue = options[i].textContent || options[i].innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                options[i].style.display = "";
                if (!hasVisible) {
                    select.selectedIndex = i;
                    hasVisible = true;
                }
            } else {
                options[i].style.display = "none";
            }
        }
    }

    // Attachment Logic
    let selectedFiles = new DataTransfer();

    function updateFileList() {
        const list = document.getElementById('file-list');
        const input = document.getElementById('attachment');

        list.innerHTML = '';
        if (selectedFiles.files.length > 0) {
            list.classList.remove('hidden');
            Array.from(selectedFiles.files).forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-dark-border';
                div.innerHTML = `
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <div class="w-8 h-8 rounded bg-primary/10 flex items-center justify-center flex-shrink-0 text-primary">
                            <i class="fa-solid ${getFileIcon(file.type)}"></i>
                        </div>
                        <div class="truncate">
                            <p class="text-xs font-bold truncate">${file.name}</p>
                            <p class="text-[10px] text-muted">${formatSize(file.size)}</p>
                        </div>
                    </div>
                    <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 p-2">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        } else {
            list.classList.add('hidden');
        }

        input.files = selectedFiles.files;
    }

    function getFileIcon(type) {
        if (type.includes('image')) return 'fa-image';
        if (type.includes('pdf')) return 'fa-file-pdf';
        if (type.includes('word') || type.includes('document')) return 'fa-file-word';
        if (type.includes('excel') || type.includes('sheet')) return 'fa-file-excel';
        return 'fa-file';
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeFile(index) {
        const dt = new DataTransfer();
        Array.from(selectedFiles.files).forEach((file, i) => {
            if (i !== index) dt.items.add(file);
        });
        selectedFiles = dt;
        updateFileList();
    }

    document.getElementById('attachment').addEventListener('change', function (e) {
        Array.from(this.files).forEach(file => {
            selectedFiles.items.add(file);
        });
        updateFileList();
    });

    // Paste Support
    document.addEventListener('paste', function (e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                if (blob) {
                    const file = new File([blob], blob.name || `pasted_file_${Date.now()}`, { type: blob.type });
                    selectedFiles.items.add(file);
                    updateFileList();
                }
            }
        }
    });

    // Drag & Drop
    const pasteArea = document.getElementById('paste-area');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        pasteArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        pasteArea.addEventListener(eventName, () => pasteArea.classList.add('border-primary', 'bg-primary/5'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
        pasteArea.addEventListener(eventName, () => {
            pasteArea.classList.remove('border-primary', 'bg-primary/5');
        });
    });

    pasteArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        Array.from(files).forEach(file => {
            selectedFiles.items.add(file);
        });
        updateFileList();
    });
</script>
{% endblock %}